## 记录我的一些问题，以及自己的见解，以及搜集到的答案

###消息队列

* ####为什么要使用消息队列？

  ​	这个问题出现在我补充写完一个带有消息队列的项目之后。我似乎只知道如何调用所用的消息队列提供的接口，但并不理解其背后的一切，更别说什么消息被重复消费，消息事务，消费顺序、消息丢失等等之类的问题了。之后我又想到了：

  * 如果是http连接的数据被转发到消息队列里进行处理，那么怎么保持返回的时候哪个worker也能找到对应的链接返回，难道是传递上下文进去？
  * 那岂不是一个worker对应着一个链接，那么有海量的链接进来的时候，岂不是有海量的worker就像几万跟光纤被包在一个管子里一样？大量链接通过一个端口进来，处理完又从这个管子返回，建立的链接就像光纤。
  * 之后我又想到了http请求数和进程数是什么样的关系的(http基础差啊)？一个请求链接对应一个进程？
  * 那么一台机器最多能同时建立多少个http请求啊？

  ####我的看法

  ​	为啥要用消息队列呢？大家都说使用消息队列可以使程序的耦合性更低，将接收请求与处理请求逻辑解耦。

  ​	在我负责的业务中使用消息队列的情况，调用端不需要返回值，后续处理逻辑涉及到数据库IO、以及其他第三方服务网络IO，io时间这对于cpu来说，应该是时间比较长了，如果一个http请求对应一个进程的话(假如是这样的话)，而返回必须得等那些io操作完成才返回的话，那么一个请求所占用的cpu时间就太长了。那样效率就相当低。

  ​	由于这个请求不需要返回值，那么我们可以在处理完最基础的信息后就return了，将后续的一系列io操作封装成函数，然后将该函数所需要的参数通过消息队列传入，worker取到消息后通过调用该函数进行后续处理完成整个流程。

  ​	这样就完成了接收请求与处理请求的解耦。

  关键点：**解耦**、**异步**

  ####dalao解读

  ​	当系统中出现“生产“和“消费“的速度或稳定性等因素不一致的时候，就需要消息队列，作为抽象层，弥合双方的差异。“ **消息** ”是在两台计算机间传送的数据单位。消息可以非常简单，例如只包含文本字符串；也可以更复杂，可能包含嵌入对象。消息被发送到队列中，“ **消息队列** ”是在消息的传输过程中保存消息的**容器** 。

  举几个例子

  1）业务系统触发短信发送申请，但短信发送模块速度跟不上，需要将来不及处理的消息暂存一下，缓冲压力。就可以把短信发送申请丢到消息队列，直接返回用户成功，短信发送模块再可以慢慢去消息队列中取消息进行处理。

  2）调远程系统下订单成本较高，且因为网络等因素，不稳定，攒一批一起发送。

  3）任务处理类的系统，先把用户发起的任务请求接收过来存到消息队列中，然后后端开启多个应用程序从队列中取任务进行处理。

  关键点：**生产**、**消费**、**速度不匹配**

  #### 总结

  ​	我所提的点内就体现了异步返回，还有解耦，其实还可以体现出速度不匹配，因为IO等待时间太长了。异步、解耦、销峰

  MQ消息队列机制：
  1）对系统而言，能承受更大访问压力
  2）对架构而言，松耦合，系统维护性方便
  3）对用户而言，系统访问更快，系统体验更好。

* ####何时引入消息队列？

  我的看法

  1、有大流量场景，如果流量都不大，那么正常程序应该可以应付。

  2、返回不是同步的。而且调用端不关心返回结果

  3、有生产者消费者模型的，不然这消息拿来干嘛啊

  总结：

  1、数据驱动的任务依赖

  2、上游不关心下游执行结果

  3、异步返回执行时间长

  **啥时候不使用消息队列？上游实时关注执行结果。**我马上就要的东西你给我让别人去做？那人还不确定啥时候能做好？

* ####在代码什么位置加入消息队列？

  ​	既然确定可以加入消息队列了。那么久有消息生产者，消息消费者，加入位置应该为生产者在生产完消息之后。消费者消费数据之前。

* ####如果是处理http连接，如何保证消息队列处理后返回http数据？

  研究清楚了，消息队列不适合同步返回的模式，但是如果硬是要放进去呢？worker处理完如何返回到指定的人手里？

* ####使用消息队列的好处？







### 参考文章

* [消息队列的使用场景](https://www.cnblogs.com/linjiqin/p/5720865.html)
* [为啥使用消息队列？何时引入消息队列？](https://blog.csdn.net/weixin_41141219/article/details/80643461)

* [消息队列的好处](https://blog.csdn.net/qq_38371549/article/details/78370080)

* [为什么需要消息队列，及使用消息队列的好处？](https://blog.csdn.net/qq_34531925/article/details/75457743)

